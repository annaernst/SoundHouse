<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!--Bootrap CDN-->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <!--Custom CSS-->
  <link href="../../css/styles.css" rel="stylesheet">
  <!--Favicon-->
  <link rel="icon" type="image/ico" href="../../img/logo.ico" />
  <script src="https://kit.fontawesome.com/49b915f19a.js" crossorigin="anonymous"></script>
  <title>SoundHouse</title>
</head>

<body>
  <!--NAVBAR-->
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
      <a class="navbar-brand" href="{{url_for('static', filename='index')}}">
        <img src="../../img/logo.png" alt="" width="30" height="30" class="d-inline-block align-text-top">
        SoundHouse
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link" href="{{url_for('static', filename='index')}}">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{{url_for('static', filename='join')}}">Join a band</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <!--OLD DROPDOWN
  <div class="container mt-3" style="max-width: 800px;">
    <h1 class="display-6">{{song1.title}}</h1>
    <div class="accordion" id="accordionPanelsStayOpenExample">
      <div class="accordion-item">
        <h2 class="accordion-header" id="panelsStayOpen-headingOne">
          <button class="accordion-button" type="button" data-bs-toggle="collapse"
            data-bs-target="#panelsStayOpen-collapseOne" aria-expanded="true"
            aria-controls="panelsStayOpen-collapseOne">
            Guitar
          </button>
        </h2>
        <div id="panelsStayOpen-collapseOne" class="accordion-collapse collapse show"
          aria-labelledby="panelsStayOpen-headingOne">
          <div class="accordion-body">
            <div class="card">
              <div class="card-body">
                <p>Guitar 1</p>
                <button class="btn">
                  <i class="fas fa-backward"></i>
                </button>
                <button class="btn btn">
                  <i class="fas fa-play"></i>
                </button>
                <button class="btn btn">
                  <i class="fas fa-pause"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="accordion-item">
        <h2 class="accordion-header" id="panelsStayOpen-headingTwo">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
            data-bs-target="#panelsStayOpen-collapseTwo" aria-expanded="false"
            aria-controls="panelsStayOpen-collapseTwo">
            Drums
          </button>
        </h2>
        <div id="panelsStayOpen-collapseTwo" class="accordion-collapse collapse"
          aria-labelledby="panelsStayOpen-headingTwo">
          <div class="accordion-body">
            <div class="card">
              <div class="card-body">
                <p>Drums 1</p>
                <button class="btn">
                  <i class="fas fa-backward"></i>
                </button>
                <button class="btn btn">
                  <i class="fas fa-play"></i>
                </button>
                <button class="btn btn">
                  <i class="fas fa-pause"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="accordion-item">
        <h2 class="accordion-header" id="panelsStayOpen-headingThree">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
            data-bs-target="#panelsStayOpen-collapseThree" aria-expanded="false"
            aria-controls="panelsStayOpen-collapseThree">
            Accordion Item #3
          </button>
        </h2>
        <div id="panelsStayOpen-collapseThree" class="accordion-collapse collapse"
          aria-labelledby="panelsStayOpen-headingThree">
          <div class="accordion-body">
            <strong>This is the third item's accordion body.</strong> It is hidden by default, until the collapse plugin
            adds the appropriate classes that we use to style each element. These classes control the overall
            appearance, as well as the showing and hiding via CSS transitions. You can modify any of this with custom
            CSS or overriding our default variables. It's also worth noting that just about any HTML can go within the
            <code>.accordion-body</code>, though the transition does limit overflow.
          </div>
        </div>
      </div>
    </div>
  </div>
-->

  <!--NEW TRACK LIST-->
  <div class="container responsive mt-3" style="max-width: 800px;">
    <h1 class="display-6">{{song1.title}}</h1>
    <div>
      <h5>Play Selected Tracks</h5>
      <button class="btn" type="button" onclick="for (i=0;i<le;i++){peerTracks[i].load()}">
        <i class="fas fa-backward"></i>
      </button>
      <button class="btn" type="button" onclick="for (i=0;i<le;i++){if(document.getElementById(i.toString()).checked){peerTracks[i].play();console.log('playing')}};if(document.getElementById('metv').checked){metro=setInterval(()=>{met.play()},300)}">
        <i class="fas fa-play"></i>
      </button>
      <button class="btn" type="button" onclick="for (i=0;i<le;i++){if(document.getElementById(i.toString()).checked){peerTracks[i].pause()}};clearInterval(metro)">
        <i class="fas fa-pause"></i>
      </button>
      <h5>Record New Track</h5>
      <button class="btn" type="button" onclick="save()"><i class="fas fa-save"></i></button>
      <button class="btn" type="button" onclick="start()"><i class="fas fa-play"></i></button>
      <button class="btn" type="button" onclick="stop()"><i class="fas fa-square"></i></button>
    </div>

    <!--track card-->
    <div class="scaled my-5" id="boxes"></div>
  </div>

  <!--BOOTSTRAP JS-->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
    crossorigin="anonymous"></script>
  <script>
    let i
    let le={{song1|safe}}.tracks.length
    boxes=document.getElementById("boxes")
    for (i=0;i<le;i++){
        boxes.innerHTML=boxes.innerHTML.concat('<input type="range" min="0" max="1" value="1" step=".01" class="slider" onclick="volume()" id=',(i+0.5).toString(),'><span class="form-check form-switch mb-3"><input class="form-check-input" type="checkbox" onclick="for (i=0;i<le;i++){peerTracks[i].load()}" id=',i.toString(),' role="switch"><label class="form-check-label" for=',i.toString(),'> ',{{song1|safe}}.tracks[i].title,'</label></span>')
    }
    boxes.innerHTML=boxes.innerHTML.concat('<input type="range" min="0" max="1" value="1" step=".01" class="slider" onclick="volume()" id="metvs"><span class="form-check form-switch mb-3"><input class="form-check-input" type="checkbox" onclick="for (i=0;i<le;i++){peerTracks[i].load()}" id="metv" role="switch"><label class="form-check-label" for="metv"> metronome</label></span>')
    let metro
    const met=document.createElement("AUDIO")
    met.src="/metronome.mp3"
    let id=setInterval(()=>{})
    let mbut=document.getElementById('m')
    let peerTracks=[]
    for (i=0;i<le;i++){
      peerTracks.push(document.createElement("AUDIO"))
      peerTracks[i].src="/".concat({{song1|safe}}.tracks[i].file)
    }
    volume=()=>{
      for (i=0;i<le;i++){peerTracks[i].volume=document.getElementById((i+0.5).toString()).valueAsNumber}
      met.volume=document.getElementById('metvs').valueAsNumber
    }
    var chunks = []
      start=async ()=>{
        let stream=await navigator.mediaDevices.getUserMedia({audio: true, video: false})
        let mediaRecorder=new MediaRecorder(stream,{audioBitsPerSecond: 256000})
        let filereader= new FileReader()
        let data
        mediaRecorder.start()
        mediaRecorder.ondataavailable=(e)=>{
          data=e.data
          chunks.push(data)
        }
        stop=async ()=>{
          mediaRecorder.stop()
          await new Promise(resolve => setTimeout(resolve, 100))
          console.log(chunks)
          var blob = new Blob(chunks, { 'type' : 'audio/ogg; codecs=opus' });
          chunks = []
          boxes.innerHTML=boxes.innerHTML.concat('<span class="form-check form-switch mb-3"><input id="newname" type="text"></input></span>')
          save=()=>{
            fetch("/", {method: "POST", headers: {"Content-Type": "application/octet-stream"}, body: blob});
            fetch("/title", {method: "POST", headers: {"Content-Type": "application/octet-stream"}, body: document.getElementById("newname").value})
          }
          /*url=URL.createObjectURL(blob)
          peerTrack.src=url*/
        }
      }
  </script>
</body>

</html>
